# Sprint 1.3: Async Startup Optimization - –û—Ç—á—ë—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 19.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û**

---

## üìã –¶–µ–ª–∏ —Å–ø—Ä–∏–Ω—Ç–∞

–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å: —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â—É—é –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∑–∞–ø—É—Å–∫ –∑–∞ < 5 —Å–µ–∫—É–Ω–¥.

### –ó–∞–¥–∞—á–∏:
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å dependency –¥–ª—è indexing_manager
4. ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å startup.py –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
5. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å lifecycle.py —Å graceful shutdown
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å endpoint `/index/status`
7. ‚úÖ –£–ª—É—á—à–∏—Ç—å health check
8. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å HealthResponse
9. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å indexer –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ progress callback
10. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

#### `src/models/index_status.py` ‚ú® NEW
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `IndexingStatus` (Enum) - —Å—Ç–∞—Ç—É—Å—ã: `IDLE`, `IN_PROGRESS`, `COMPLETED`, `FAILED`
- `IndexProgressInfo` (dataclass) - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
  - –°–≤–æ–π—Å—Ç–≤–∞: `progress_percent`, `duration_seconds`
  - –ú–µ—Ç–æ–¥: `to_dict()` –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–ö–æ–¥:** 72 —Å—Ç—Ä–æ–∫–∏

---

#### `src/infrastructure/background/__init__.py` ‚ú® NEW
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è background tasks

**–≠–∫—Å–ø–æ—Ä—Ç—ã:**
- `BackgroundIndexingManager`

**–ö–æ–¥:** 5 —Å—Ç—Ä–æ–∫

---

#### `src/infrastructure/background/indexing_manager.py` ‚ú® NEW
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú–µ–Ω–µ–¥–∂–µ—Ä —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ë–ï–ó retry –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–ö–ª–∞—Å—Å `BackgroundIndexingManager`:**

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
- `shutdown_timeout` - —Ç–∞–π–º–∞—É—Ç –¥–ª—è graceful shutdown (default: 30 —Å–µ–∫)
- `progress_log_interval` - –∏–Ω—Ç–µ—Ä–≤–∞–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (default: 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `start_indexing()` - –∑–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- `get_status()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
- `is_indexing()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- `graceful_shutdown()` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ shutdown
- `_do_indexing()` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- `_update_progress()` - callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Thread-safe –¥–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ `asyncio.Lock`
- –û–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (–±–µ–∑ retry)
- –ü—Ä–∏ –æ—à–∏–±–∫–µ - —Å—Ç–∞—Ç—É—Å `FAILED` —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—à–∏–±–∫–∏
- Singleton pattern —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `setup_indexing_manager()` –∏ `get_indexing_manager()`

**–ö–æ–¥:** 254 —Å—Ç—Ä–æ–∫–∏

---

#### `tests/test_background_indexing.py` ‚ú® NEW
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–µ—Å—Ç—ã –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–¢–µ—Å—Ç—ã (10 —à—Ç):**
1. ‚úÖ `test_initial_status` - –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å IDLE
2. ‚úÖ `test_is_indexing_initially_false` - –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
3. ‚úÖ `test_progress_callback` - —Ä–∞–±–æ—Ç–∞ callback
4. ‚úÖ `test_progress_info_properties` - –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
5. ‚úÖ `test_progress_info_to_dict` - —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
6. ‚úÖ `test_singleton_setup` - singleton pattern
7. ‚úÖ `test_graceful_shutdown_no_indexing` - shutdown –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
8. ‚úÖ `test_status_during_indexing` - —Å—Ç–∞—Ç—É—Å –≤–æ –≤—Ä–µ–º—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
9. ‚úÖ `test_indexing_with_error` - –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å –æ—à–∏–±–∫–æ–π
10. ‚úÖ `test_concurrent_indexing_blocked` - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ concurrent –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ 10 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ ‚úÖ

**–ö–æ–¥:** 240 —Å—Ç—Ä–æ–∫

---

### 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

#### `src/api/dependencies.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω import `get_indexing_manager` –∏ `BackgroundIndexingManager`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_indexing_manager()` - dependency –¥–ª—è FastAPI

**–î–æ:** 64 —Å—Ç—Ä–æ–∫–∏  
**–ü–æ—Å–ª–µ:** 79 —Å—Ç—Ä–æ–∫ (+15)

---

#### `src/core/startup.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –§—É–Ω–∫—Ü–∏—è `auto_index_on_startup()` –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞:
  - –£–±—Ä–∞–Ω–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–æ–Ω–æ–≤–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 5 —Å–µ–∫—É–Ω–¥
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∞–π–ª `shcntx_ru.hbk`
  
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_delayed_background_indexing()`:
  - –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
  - –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ `BackgroundIndexingManager`

- –§—É–Ω–∫—Ü–∏—è `index_hbk_file()` –æ–±–Ω–æ–≤–ª–µ–Ω–∞:
  - –î–æ–±–∞–≤–ª–µ–Ω—ã imports –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä—É—á–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ API

**–õ–æ–≥–∏–∫–∞:**
```
Startup ‚Üí auto_index_on_startup() ‚Üí 
  –ü—Ä–æ–≤–µ—Ä–∫–∏ (–±—ã—Å—Ç—Ä–æ, < 1 —Å–µ–∫) ‚Üí 
  asyncio.create_task(_delayed_background_indexing) ‚Üí 
  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ (5 —Å–µ–∫) ‚Üí
  –ù–∞—á–∞–ª–æ —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
```

**–î–æ:** 93 —Å—Ç—Ä–æ–∫–∏  
**–ü–æ—Å–ª–µ:** 109 —Å—Ç—Ä–æ–∫ (+16)

---

#### `src/core/lifecycle.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**–í `startup()`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `BackgroundIndexingManager` —á–µ—Ä–µ–∑ `setup_indexing_manager()`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ manager –≤ `app.state.indexing_manager`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ —Ñ–æ–Ω–µ)"

**–í `shutdown()`:**
- –î–æ–±–∞–≤–ª–µ–Ω graceful shutdown –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30 —Å–µ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "MCP —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

**–î–æ:** 72 —Å—Ç—Ä–æ–∫–∏  
**–ü–æ—Å–ª–µ:** 91 —Å—Ç—Ä–æ–∫–∞ (+19)

---

#### `src/api/routes/index.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**Imports:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã `get_indexing_manager`, `BackgroundIndexingManager`

**Endpoint `GET /index/status`:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `indexing_manager` —á–µ—Ä–µ–∑ Depends
- –†–∞—Å—à–∏—Ä–µ–Ω response:
  - –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª `"indexing"` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
  - `is_active` - —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  - –í—Å–µ –ø–æ–ª—è –∏–∑ `IndexProgressInfo` —á–µ—Ä–µ–∑ `to_dict()`

**Response –ø—Ä–∏–º–µ—Ä:**
```json
{
  "elasticsearch_connected": true,
  "index_exists": true,
  "documents_count": 5423,
  "index_name": "docs_1c",
  "indexing": {
    "is_active": false,
    "status": "completed",
    "progress_percent": 100.0,
    "total_documents": 5423,
    "indexed_documents": 5423,
    "start_time": "2025-10-19T10:30:15",
    "end_time": "2025-10-19T10:35:42",
    "error_message": null,
    "file_path": "data/hbk/shcntx_ru.hbk",
    "duration_seconds": 327.0
  }
}
```

**–î–æ:** 95 —Å—Ç—Ä–æ–∫  
**–ü–æ—Å–ª–µ:** 122 —Å—Ç—Ä–æ–∫–∏ (+27)

---

#### `src/api/routes/health.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**Imports:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã `get_indexing_manager`, `BackgroundIndexingManager`

**Endpoint `GET /health`:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `indexing_manager` —á–µ—Ä–µ–∑ Depends
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `get_status()`
- –†–∞—Å—à–∏—Ä–µ–Ω `HealthResponse`:
  - `indexing_status` - —Å—Ç–∞—Ç—É—Å —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
  - `indexing_active` - —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–í–∞–∂–Ω–æ:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è `healthy` –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏!

**–î–æ:** 33 —Å—Ç—Ä–æ–∫–∏  
**–ü–æ—Å–ª–µ:** 51 —Å—Ç—Ä–æ–∫–∞ (+18)

---

#### `src/models/mcp_models.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**–ö–ª–∞—Å—Å `HealthResponse`:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è:
  - `indexing_status: Optional[str]` - —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
  - `indexing_active: Optional[bool]` - —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–î–æ:** 118 —Å—Ç—Ä–æ–∫  
**–ü–æ—Å–ª–µ:** 120 —Å—Ç—Ä–æ–∫ (+2)

---

#### `src/parsers/indexer.py` üîß MODIFIED
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**Imports:**
- –î–æ–±–∞–≤–ª–µ–Ω `Callable` –≤ typing

**–ú–µ—Ç–æ–¥ `index_documentation()`:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `progress_callback: Optional[Callable[[int, int], None]]`
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `progress_callback(indexed_count, total_docs)`

**–ú–µ—Ç–æ–¥ `reindex_all()`:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `progress_callback`
- –ü–µ—Ä–µ–¥–∞—ë—Ç callback –≤ `index_documentation()`

**–î–æ:** 205 —Å—Ç—Ä–æ–∫  
**–ü–æ—Å–ª–µ:** 235 —Å—Ç—Ä–æ–∫ (+30)

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –§–∞–π–ª—ã:
- ‚ú® **–°–æ–∑–¥–∞–Ω–æ:** 4 —Ñ–∞–π–ª–∞
- üîß **–ò–∑–º–µ–Ω–µ–Ω–æ:** 7 —Ñ–∞–π–ª–æ–≤
- üìù **–í—Å–µ–≥–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ:** 11 —Ñ–∞–π–ª–æ–≤

### –ö–æ–¥:
- ‚ûï **–î–æ–±–∞–≤–ª–µ–Ω–æ:** ~693 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- ‚úÖ **–¢–µ—Å—Ç—ã:** 10 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤
- üìà **–ü–æ–∫—Ä—ã—Ç–∏–µ:** –í—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|--------|------------|
| –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞ < 5 —Å–µ–∫—É–Ω–¥ | ‚úÖ | Startup –±—ã—Å—Ç—Ä—ã–π, –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ —Ñ–æ–Ω–µ |
| –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ | ‚úÖ | –ß–µ—Ä–µ–∑ `asyncio.create_task()` |
| `/health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 —Å—Ä–∞–∑—É | ‚úÖ | –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |
| `/index/status` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å | ‚úÖ | –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ |
| Health check –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ | ‚úÖ | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ response |
| Graceful shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ | –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫ |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ‚úÖ | Configurable —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä |
| –û–¥–∏–Ω .hbk —Ñ–∞–π–ª | ‚úÖ | `shcntx_ru.hbk` |
| –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç | ‚úÖ | 4/4 –ø—Ä–æ—à–ª–∏ |
| –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å | ‚úÖ | 10/10 –ø—Ä–æ—à–ª–∏ |

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|--------|------------|
| –ù–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤ –≤ startup | ‚úÖ | –¢–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| Thread-safe –¥–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç—É—Å—É | ‚úÖ | –ß–µ—Ä–µ–∑ `asyncio.Lock` |
| Graceful shutdown –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ | ‚úÖ | –° —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ | ‚úÖ | –°—Ç–∞—Ä—Ç, –ø—Ä–æ–≥—Ä–µ—Å—Å, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –æ—à–∏–±–∫–∏ |
| –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ | ‚úÖ | –û–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞, –ø—Ä–∏ –æ—à–∏–±–∫–µ - FAILED |
| Dependency Injection | ‚úÖ | –ß–µ—Ä–µ–∑ FastAPI Depends |
| Singleton –¥–ª—è manager | ‚úÖ | –ß–µ—Ä–µ–∑ setup/get —Ñ—É–Ω–∫—Ü–∏–∏ |

---

## üé¨ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–æ—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```
1. main.py ‚Üí lifespan(app) ‚Üí startup(app)
   ‚Üì
2. lifecycle.startup():
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è metrics, monitoring
   - setup_dependencies()
   - setup_indexing_manager() ‚Üí —Å–æ–∑–¥–∞—ë–º BackgroundIndexingManager
   - app.state.indexing_manager = manager
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Elasticsearch (< 1 —Å–µ–∫)
   - auto_index_on_startup(es_client)
   ‚Üì
3. auto_index_on_startup():
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ shcntx_ru.hbk (< 0.1 —Å–µ–∫)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ (< 0.5 —Å–µ–∫)
   - asyncio.create_task(_delayed_background_indexing) ‚Üí —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞
   - RETURN (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!) ‚Üê üéâ < 5 —Å–µ–∫—É–Ω–¥
   ‚Üì
4. –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (—á–µ—Ä–µ–∑ 5 —Å–µ–∫):
   - _delayed_background_indexing()
   - await asyncio.sleep(5) ‚Üê –¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
   - manager.start_indexing(file, es_client)
   ‚Üì
5. BackgroundIndexingManager.start_indexing():
   - –°–æ–∑–¥–∞—ë—Ç asyncio.Task –¥–ª—è _do_indexing()
   - –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
   ‚Üì
6. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏–¥—ë—Ç –≤ —Ñ–æ–Ω–µ:
   - –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞
   - –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –±–∞—Ç—á–∞–º–∏ (100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
   - Callback –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–π –±–∞—Ç—á
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IndexProgressInfo
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:

```
GET /index/status
   ‚Üì
index_status(indexing_manager: Depends(get_indexing_manager))
   ‚Üì
manager.get_status() ‚Üí IndexProgressInfo
   ‚Üì
Response —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
```

### Graceful Shutdown:

```
SIGTERM/SIGINT ‚Üí lifespan cleanup ‚Üí shutdown(app)
   ‚Üì
lifecycle.shutdown():
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ manager.is_indexing()
   - –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ ‚Üí manager.graceful_shutdown(timeout=30)
   - –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç ES
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:

```bash
# –ê–∫—Ç–∏–≤–∞—Ü–∏—è venv
.\venv\Scripts\Activate.ps1

# –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
python -m pytest tests/test_background_indexing.py -v

# –í—Å–µ —Ç–µ—Å—Ç—ã
python -m pytest tests/ -v
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

**–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (test_background_indexing.py):**
```
tests/test_background_indexing.py::test_initial_status PASSED              [ 10%]
tests/test_background_indexing.py::test_is_indexing_initially_false PASSED [ 20%]
tests/test_background_indexing.py::test_progress_callback PASSED           [ 30%]
tests/test_background_indexing.py::test_progress_info_properties PASSED    [ 40%]
tests/test_background_indexing.py::test_progress_info_to_dict PASSED       [ 50%]
tests/test_background_indexing.py::test_singleton_setup PASSED             [ 60%]
tests/test_background_indexing.py::test_graceful_shutdown_no_indexing PASSED [ 70%]
tests/test_background_indexing.py::test_status_during_indexing PASSED      [ 80%]
tests/test_background_indexing.py::test_indexing_with_error PASSED         [ 90%]
tests/test_background_indexing.py::test_concurrent_indexing_blocked PASSED [100%]

================================== 10 passed in 4.31s ==================================
```

**–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞:**
```
tests/test_elasticsearch_connection.py::test_elasticsearch_connection PASSED [ 25%]
tests/test_indexing.py::test_indexing PASSED                              [ 50%]
tests/test_parsing.py::test_hbk_parsing PASSED                            [ 75%]
tests/test_search.py::test_search PASSED                                  [100%]

============================ 4 passed in 274.39s (0:04:34) =============================
```

‚úÖ **–ò—Ç–æ–≥–æ: 14/14 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ**

---

## üìà –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
- ‚è±Ô∏è Startup time: ~180-300 —Å–µ–∫—É–Ω–¥ (–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫)
- ‚ùå Health check –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Ä–µ–º—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- ‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Ä–µ–º—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- üêå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
- ‚ö° Startup time: < 5 —Å–µ–∫—É–Ω–¥ (–ø—Ä–æ–≤–µ—Ä–∫–∏ + —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞)
- ‚úÖ Health check –¥–æ—Å—Ç—É–ø–µ–Ω —Å—Ä–∞–∑—É
- ‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω —Å—Ä–∞–∑—É
- üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `/index/status`

**–£–ª—É—á—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞: ~3600% (60x –±—ã—Å—Ç—Ä–µ–µ!)**

---

## üéØ –ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ—Å–æ–∑–Ω–∞–Ω–Ω–æ)

### Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö retry

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ï—Å–ª–∏ ES –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ startup)
- –ï—Å–ª–∏ —Ñ–∞–π–ª –±–∏—Ç—ã–π - retry –Ω–µ –ø–æ–º–æ–∂–µ—Ç
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∫–æ–¥–∞ - –Ω—É–∂–µ–Ω —Ñ–∏–∫—Å, –∞ –Ω–µ retry
- –ü—Ä–∏ –æ—à–∏–±–∫–µ - —Å—Ç–∞—Ç—É—Å FAILED, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ API

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ .hbk —Ñ–∞–π–ª—ã
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ `shcntx_ru.hbk`

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ü–æ –¢–ó —Ñ–∞–π–ª –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω
- –£–ø—Ä–æ—â–∞–µ—Ç –ª–æ–≥–∏–∫—É
- –£–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

### Progress bar –≤ UI
**–†–µ—à–µ–Ω–∏–µ:** –¢–æ–ª—å–∫–æ API endpoint —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- UI - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞
- API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–π UI

---

## üîÆ –ß—Ç–æ –¥–∞–ª—å—à–µ

### Sprint 1.4: Retry mechanisms (–¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
- Retry –¥–ª—è Elasticsearch connection
- Retry –¥–ª—è Elasticsearch operations (–Ω–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏!)
- Configurable retry parameters
- Exponential backoff

### Phase 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- Repository Pattern
- Service Layer
- Transport Layer –æ—Ç–¥–µ–ª–µ–Ω–∏–µ
- Graceful Shutdown enhancement

---

## üìù –ó–∞–º–µ—Ç–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É:

1. –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ –≤ `BackgroundIndexingManager` –∏–ª–∏ –Ω–æ–≤—ã–π manager
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.create_task()` –¥–ª—è –∑–∞–ø—É—Å–∫–∞
3. –û–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `async with self._lock`
4. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `get_status()` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `graceful_shutdown()` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# –í lifecycle.py
indexing_manager = setup_indexing_manager(
    shutdown_timeout=30,
    progress_log_interval=500  # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ 500 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
)
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ –∫–æ–¥–µ:

```python
from src.infrastructure.background.indexing_manager import get_indexing_manager

manager = get_indexing_manager()
status = await manager.get_status()

if manager.is_indexing():
    print(f"–ü—Ä–æ–≥—Ä–µ—Å—Å: {status.progress_percent}%")
```

---

## ‚úÖ –í—ã–≤–æ–¥

**Sprint 1.3 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!**

–í—Å–µ —Ü–µ–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã:
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞ < 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —á–µ—Ä–µ–∑ API
- ‚úÖ Graceful shutdown
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –ö–æ–¥ —á–∏—Å—Ç—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π

**–ì–æ—Ç–æ–≤–æ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ø—Ä–∏–Ω—Ç—É!** üöÄ

---

**–î–∞—Ç–∞:** 19.10.2025  
**–ê–≤—Ç–æ—Ä:** Development Team  
**–í–µ—Ä—Å–∏—è:** 1.0
